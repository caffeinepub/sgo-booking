{
  "kind": "build_request",
  "title": "Fix backend API regressions for hotel profile saving and cross-portal hotel visibility",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-4",
      "text": "Align the backend canister Candid API with the frontend’s `ExtendedBackendInterface` so the runtime errors like `extendedActor.updateHotelProfile is not a function` and other missing-method errors cannot occur.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "ya sudah build ulang. Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "From the hotel portal, clicking “Save Changes” on the Hotel Profile page no longer shows `extendedActor.updateHotelProfile is not a function`.",
        "From the hotel portal, creating/updating a room no longer shows `extendedActor.createRoom is not a function` / `extendedActor.updateRoom is not a function`.",
        "Frontend pages that call the backend via `ExtendedBackendInterface` (hotels list, hotel profile, rooms CRUD, admin visibility toggles) do not fail due to missing canister methods."
      ]
    },
    {
      "id": "REQ-5",
      "text": "Implement `updateHotelProfile(name, location, address, mapLink, whatsapp, email)` in `backend/main.mo` with the exact parameter order expected by the frontend, and persist the updated fields into the caller’s hotel record.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "When an activated hotel updates fields (name/location/address/mapLink/whatsapp/email) and clicks Save, the call succeeds and a subsequent fetch (`getCallerHotelProfile`) returns the updated data.",
        "If the caller is an activated hotel but has no existing record in `hotelsMap`, `updateHotelProfile` creates an initialized default hotel profile first (without losing any existing rooms already stored for that hotel).",
        "The backend enforces that only the hotel owner (caller) can update its own profile (admin override allowed if already supported elsewhere)."
      ]
    },
    {
      "id": "REQ-6",
      "text": "Fix/restore room APIs to match frontend signatures: implement `getRooms(filters: RoomQuery)`, `createRoom(roomNumber, roomType, pricePerNight, currency, pictures)`, and `updateRoom(roomId, roomNumber, roomType, pricePerNight, currency, pictures)` in `backend/main.mo`, ensuring they work for activated hotels.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "`getRooms(filters)` exists and accepts a `RoomQuery` record (including optional hotelId/minPrice/maxPrice/roomType/availableOnly), and returns a filtered list of `RoomView`.",
        "`createRoom(...)` returns `RoomView` and persists the created room, including `pictures` URLs/data-URLs provided by the frontend.",
        "`updateRoom(...)` returns `RoomView` and persists the updated room fields, including updated `pictures`.",
        "Rooms created by a hotel are included in that hotel’s `HotelDataView.rooms` when fetched via `getCallerHotelProfile()` and `getHotels()`."
      ]
    },
    {
      "id": "REQ-7",
      "text": "Ensure an activated hotel can create rooms and appear in admin/guest hotel lists even if their hotel profile record did not previously exist, by initializing and maintaining a consistent hotel record in storage (including a maintained list of room IDs).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "If an activated hotel creates its first room before saving its profile, the backend automatically creates the hotel record and associates the new room with it.",
        "After creating a room, the hotel is visible in the admin hotel list (`getHotels`) and guest browse list (subject to active/subscription rules).",
        "`getCallerHotelProfile()` returns a hotel profile that includes the newly created room(s)."
      ]
    },
    {
      "id": "REQ-8",
      "text": "Implement/restore `getHotels()` in `backend/main.mo` to return the hotel list used by both admin visibility tools and guest browsing, and ensure hotels marked active are returned so the guest Browse Hotels page does not show “No Hotels Available” incorrectly.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "When at least one hotel exists with `active = true`, `getHotels()` returns a non-empty list including that hotel.",
        "Guest Browse Hotels page (`BrowseHotelsPage`) shows returned hotels instead of “No Hotels Available” when active hotels exist.",
        "Returned `HotelDataView` includes `rooms` with `pictures` so representative photos can render when available."
      ]
    },
    {
      "id": "REQ-9",
      "text": "Implement admin hotel management APIs required by the existing admin UI: `setHotelActiveStatus(hotelId, active)` and `setHotelSubscriptionStatus(hotelId, status)` in `backend/main.mo`, enforcing admin-only access.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "From the Admin Panel > Hotel Visibility Control, toggling Active status succeeds and persists; refreshing the hotel list reflects the change.",
        "From the Admin Panel > Hotel Visibility Control, changing Subscription status succeeds and persists; refreshing reflects the change.",
        "Non-admin callers cannot call these methods successfully (backend rejects/traps)."
      ]
    },
    {
      "id": "REQ-10",
      "text": "Restore/implement any additional backend methods referenced by the frontend hooks so authentication/role checks and invite token flow do not error at runtime (at minimum: `getCallerUserRole`, `isCallerAdmin`, `makeMeAdmin`, `validateInviteToken`).",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "Navigating the app with an authenticated user does not throw due to missing role/admin/token methods.",
        "Hotel activation flow that validates and consumes invite tokens works without missing-method runtime errors.",
        "Admin-only UI sections that depend on `isCallerAdmin` and `getCallerUserRole` can load without runtime exceptions."
      ]
    },
    {
      "id": "REQ-11",
      "text": "Add a focused regression check (manual or automated where applicable) using the existing `frontend/REGRESSION_CHECKLIST.md` flow to verify: hotel profile saving, room create/update with photos, guest browse hotel visibility, and admin hotel visibility toggles.",
      "target": "both",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "Tolong jangan sampai gagal dan error."
        ]
      },
      "acceptanceCriteria": [
        "Hotel portal: profile Save succeeds and persists after refresh.",
        "Hotel portal: create room + upload/add pictures succeeds; room persists after refresh.",
        "Guest portal: Browse Hotels lists active hotels; can open a hotel detail page.",
        "Admin portal: Hotel Visibility Control lists hotels and can toggle active/subscription status without errors."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in `backend/main.mo` (no additional backend services).",
    "Do not modify any files under `frontend/src/components/ui` (read-only components).",
    "Do not edit immutable frontend paths listed in SYSTEM_CONTEXT (compose them instead)."
  ],
  "nonGoals": [
    "Adding new product features beyond fixing the described regressions (e.g., new booking logic, new payment providers, real-time updates).",
    "Introducing external databases or third-party authentication providers."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}